---
title: "6/ 文書とスライドの共有"
modified-date: today
format: 
  revealjs:
    footer: "文書とスライドの共有"
metadata-files: 
  - "style/slide.yml"
---

```{r}
#| include: false
pacman::p_load(tidyverse)
```

{{< include _common.qmd >}}

# **1** 共有方法

## （通常の）HTMLファイルの限界

- 我々が見ているWEBブラウザ上の画面は1つのHTMLファイル**だけではない**。
   - HTML[（骨格とテキスト）]{.small}、CSS[（見た目、書式）]{.small}、画像・動画、JavaScript^[短いJavaScriptはHTMLに埋め込まれているが、重めのJavaScriptは外部のものを読み込むことが多い]など
- HTMLだけを共有しても、我々が想定したものと違ったものが表示される。
   - HTML単体にすべてのものを埋め込む必要がある

::: {layout-ncol=2}
![StandaloneなHTML](figs/share/full_html.png){style="border: 1px solid #CCCCCC;"}

![HTMLのみ（CSS/JavaScript抜き）](figs/share/raw_html.png){style="border: 1px solid #CCCCCC;"}
:::

## HTML形式ファイルの共有方法

- 文書、スライドを共有する方法
   - ファイルとして共有する[（Harvard Dataverse、USB、メールの添付ファイルなど）]{.small}
      - [**PDF化**]{.alert}する
      - [**StandaloneなHTML**]{.alert}ファイルにする
   - ネットに公開する
      - [**Quarto Pub**]{.alert}、GitHub Pages、Posit Connect、Netifly、Hugging Face、...

# **2** ファイル

## Standalone HTMLファイルの作成

YAMLヘッダーを修正[（`html:`、または`revealjs:`の下）]{.small}

- 文書、スライド共通
- ファイルのサイズが非常に大きくなるので注意
   - `embed-resources`：画像[（コードから生成された図を含む）]{.small}、CSS、JavaScript^[数式レンダリングエンジンを除く]等をHTML内に埋め込む
   - `self-contained-math`：数式レンダリングエンジン[（MathJax等）]{.small}を埋め込む

````yaml
format:
  html:
    embed-resources: true
    self-contained-math: true
````

## PDFファイルの作成

- 文書
   - HTMLファイルをWebブラウザ[（Firefox、Chrome、Edge、Safari、...）]{.small}でPDF印刷
      - あまり推奨はできない
   - `format: pdf`にして最初からPDF文書として作成する[（第4講参照）]{.small}
- スライド
   - HTMLファイルをWebブラウザでPDF印刷[（第5講参照）]{.small}
   - `format: beamer`にして最初からPDFスライドとして作成する[（第5講参照）]{.small}

# **3** Quarto Pub

## Quarto Pub

- Quartoで作成したHTMLファイル[（文書、スライド、Website、Web-book）]{.small}をネット上に公開できるサービス
   - [**無料**]{.alert}（容量[100MB]、およびトラフィック[10GB/月]の制限あり）
   - <https://quartopub.com/>[（会員登録が必要）]{.small}
- R Markdown時代（?）の[RPubs](https://rpubs.com/)に類似したサービス[（上位互換?）]{.small}
   - ドキュメント単位だけでなく、プロジェクト単位[（Website/Blog/Web-book）]{.small}の公開も可能
   - GitHub Actionも使用可能
- 詳細な使い方は<https://quarto.org/docs/publishing/quarto-pub.html>から

<!--- 
- 管理用ページ[（<https://quartopub.com/>）]{.small}と公開用ページ[（<https://ユーザーID.quarto.pub/>）]{.small}の区別 
--->

## 使い方（1）

共通：**Terminal**ペインを使用（Consoleベイン**じゃない**）

- 個別の文書、スライドの場合[（本日はこのケースを紹介）]{.small}
   - `quarto publish quarto-pub ファイル名.qmd`を入力
   - `.qmd`ファイルが別のフォルダーに入っている場合、ファイルのパスを入力
- Website/Web-bookの場合
   - `quarto publish quarto-pub`を入力
   - プロジェクトが位置したフォルダーから実行

## 使い方（2）

1. Terminalペインで以下のコマンドを入力

```bash
quarto publish quarto-pub my_quarto.qmd
```

2. 以下のメッセージが表示されたら「Y」を入力し、Enter（Return）キー

```md
? Authorize (Y/n) › 
❯ In order to publish to Quarto Pub you need to authorize your account.
  Please be sure you are logged into the correct Quarto Pub account in your
  default web browser, then press Enter or 'Y' to authorize.
```

3. WebブラウザーからQuarto Pubへログインし、ALLOWをクリック
   - Webブラウザーが開かず、`Please authorize by opening this url: https://quartopub.com/authorize?id=xxx`が表示されたら、URLをコピペしてアクセスする

## 使い方（3）

4. 以下のようなメッセージが表示されたら、上下キーで操作する。
   - デフォルトは`.qmd`ファイルの`title`のまま
   - 公開用URLにも使われるので、なるべく英数字のみの名前を付けよう
      - 上下キーでUse another name...を選択し、新しい名前をつける

```md
? Document name:
❯ はじめてのQuarto
  Use another name...
```

5. しばらく待ったら、公開完了
   - <https://ユーザーID.quarto.pub/>から公開したものの一覧が確認できる
      - 個別のファイルは<https://ユーザーID.quarto.pub/ドキュメント名/>から
   - 公開したファイルの削除、URLの変更は<https://quartopub.com/>から
6. 更新も同じ手順
   - 更新するか、新しいファイルとして公開するかを選択する必要はある

# **4** GitHub Pages

## GitHub Pages

- GitHubレポジトリ内の静的HTMLファイルを外部に公開するサービス
   - [**無料**]{.alert}
   - 容量[（各レポジトリ1GB）]{.small}、トラフィック[（100GB/月）]{.small}、ビルド[（10回/1時間）]{.small}などの制限付き
- gitおよびGitHubの使い方は省略
   - これだけで1日講座が作れます...。
   - ここで紹介するファイルのアップロード方法は正攻法でなく、邪道に近いもの
      - GitHub CLI、GitHub Desktop、SourceTree、GitKraken
      - RStudioやVS Code（Positron）とGitHubの連携

## GitHubレポジトリの作成

1. 画面左の「Create Repository」、または「New」ボタンをクリック
2. レポジトリ名[（Repository name）]{.small}を入力し、Add READMEをONにする。

![](figs/share/github_create_repo.png){fig-align="center"}

## ファイルのアップロード（1）

1. Add file > Upload filesを選択

![](figs/share/github_upload_1.png){fig-align="center"}

## ファイルのアップロード（2）

2. 必要なファイルをDrag & Dropし、下段の「Commit changes」

:::: {.columns}
::: {.column width=50%}
![](figs/share/github_upload_2.png)
:::

::: {.column width=50%}
- Standalone HTMLならファイルのみ
- それ以外の場合、`*_files`フォルダーや画像が格納されているフォルダー^[`![](画像のパス)`でローカルの画像を埋め込んだ場合など]等も入れる必要がある。
:::
::::

## GitHub Pagesの設定

1. Settingsメニュー（①）を選択し、Pagesタブ（②）へ
2. BranchのNoneをmainに変更（③）

![](figs/share/github_pages.png){fig-align="center"}

## アップロードしたファイルの確認方法

- <https://ユーザー名.github.io/レポジトリ名/ファイル名.html>から確認可能
   - HTMLファイルがサブフォルダーに書くのされている場合、<https://ユーザー名.github.io/レポジトリ名/フォルダ名/ファイル名.html>の形式
   - レポジトリ名が`ユーザー名.github.io`なら<https://ユーザー名.github.io/ファイル名.html>のようになるが、詳細は割愛^[主にホームページを作成する時に使う。この場合、WebページのHTMLファイルが`docs`フォルダーに入っていることが多いので、Branchのフォルダーを/(root)でなく、docsに設定することが多い。]
- アップロードしてから反映されるまで時間がかかる[（スライドや文書程度なら1〜2分）]{.small}
   - Actionsメニューから処理状況が確認できる。

# **5** 共有時の注意事項

## R、パッケージのバージョン情報

#### 時々刻々変化し続けるR生態系

- 膨大なパッケージとその更新の早さはR最大のメリット
- 一方、パッケージの仕様変更により[**過去使えた関数が、今は使えない**]{.alert}ケースも
   - または、引数名や実引数のクラスが変わることも
- $\Rightarrow$ 過去のコードが今でも当時と100%同じように動作する保証はどこにもない

#### 対処方法

- セッション情報やパッケージのバージョンを明記[（多くの場合、これで十分）]{.small}
- {renv}やdocker、mybinder.orgなどのパッケージ・サービスを利用

## セッション情報

Rのバージョン、読み込み中パッケージの情報などが表示される

- 文書やスライドの最後に入れておく
- 特定のバージョンのパッケージは`devtools::install_version()`でインストール

```{r}
#| echo: true
sessionInfo()
```

## 全パッケージのバージョン情報

情報量が多すぎるので非推奨

```{r}
#| echo: true
installed.packages()[, "Version"]
```

## {renv}パッケージ

「ある時点の」RおよびRパッケージを記録し、呼び戻すパッケージ

1. `renv::init()`：「今の」Rバージョン、パッケージ情報を保存
   - Rのバージョン、パッケージのバージョンの情報はテキストファイルとして`renv.lock`というファイルに保存される
   - `renv/library`フォルダーには`renv::init()`を打った時点のライブラリ[（のシンボリックリンク）]{.small}がすべて保存される
1. `renv::resotre()`：環境の呼び戻し
   - RStudioを使用中ならプロジェクトを開く際、自動的に作動する[（=RStudioプロジェクト機能と相性が良い）]{.small}^[異なるPC環境でプロジェクトを開くとパッケージが見つからないとのメッセージが表示されるが、この場合、コンソールに`renv::repair()`を入力すると、`renv.lock`に記録されている情報を元に環境が再現される。]
1. `renv::snapshot()`：更新

- 簡単なチュートリアルは[『私たちのR』](https://www.jaysong.net/RBook/renv.html)、詳細は[公式ホームページ](https://rstudio.github.io/renv/index.html)を参照
   - 他人に共有する場合、プロジェクトごとに渡す必要があるため非効率的

## mybinder.org

- 再現・再生用のデータセットとコード[（またはQuartoファイル）]{.small}、+ $\alpha$を格納したGitHubレポジトリ
   - $\alpha$：`apt.txt`、`environment.yml`、`postBuild`など
   - `environment.yml`内にRおよびパッケージの情報を明記
- サンプルレポジトリ：<https://github.com/JaehyunSong/quarto_binder>
- 詳細は[公式ホームページ](https://jupyter.org/binder)を参照